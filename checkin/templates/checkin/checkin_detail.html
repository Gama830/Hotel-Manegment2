{% extends 'base.html' %}
{% load static %}
{% load datetime_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/common.css' %}" />
<style>
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-paid {
        background: #d4edda;
        color: #155724;
    }

    .status-partial {
        background: #fff3cd;
        color: #856404;
    }

    .status-pending {
        background: #f8d7da;
        color: #721c24;
    }

    .status-refunded {
        background: #e2e3e5;
        color: #383d41;
    }

    .status-active {
        color: #28a745;
        font-weight: bold;
    }

    .status-inactive {
        color: #dc3545;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">
            üè® Check-In Details - {{ checkin.check_in_id }}
        </h1>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'checkin-update' checkin.id %}" class="btn btn-warning">
                ‚úèÔ∏è Edit Check-In
            </a>
            {% if not checkin.id_proof_verified %}
            <form method="post" action="{% url 'checkin-verify-id' checkin.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success" onclick="return confirm('Mark ID as verified?')">
                    ‚úì Verify ID
                </button>
            </form>
            {% endif %}
            <a href="{% url 'checkin-list' %}" class="btn btn-secondary">
                ‚Üê Back to Check-Ins
            </a>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        <!-- Main Information -->
        <div class="card">
            <div class="card-body">
                <h3
                    style="color: #667eea; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                    üè® Check-In Information
                </h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Check-In
                            ID:</label>
                        <p
                            style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px; font-family: monospace;">
                            {{ checkin.check_in_id }}</p>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Type:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            {% if checkin.is_walk_in %}
                            <span style="color: #17a2b8;">üö∂ Walk-in Guest</span>
                            {% else %}
                            <span style="color: #28a745;">üìã Pre-booked {{ checkin.booking.booking_id }}</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label
                            style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Guest:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <strong>{{ checkin.guest.full_name }}</strong><br>
                            <small>{{ checkin.guest.email }} | {{ checkin.guest.phone_number }}</small>
                        </p>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Room:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <strong>Room {{ checkin.room_number.room_number }}</strong><br>
                            <small>{{ checkin.room_number.room_type }} - {{ checkin.room_number.get_status_display
                                }}</small>
                        </p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Check-In Date
                            & Time:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            {{ checkin.actual_check_in_date_time|indian_datetime_12h }}
                        </p>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Expected
                            Check-Out:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            {% if checkin.expected_check_out_date %}
                            {{ checkin.expected_check_out_date|date:"M d, Y" }}
                            {% else %}
                            <span style="color: #666;">Not specified</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Number of
                            Guests:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">{{
                            checkin.number_of_guests }} guest{{ checkin.number_of_guests|pluralize }}</p>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Assigned
                            Staff:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">{{
                            checkin.assigned_staff|default:"Not assigned" }}</p>
                    </div>
                </div>

                <h3
                    style="color: #667eea; margin: 30px 0 20px 0; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                    üí≥ Payment & Verification
                </h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Payment
                            Status:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <span
                                class="status-badge {% if checkin.payment_status == 'PAID' %}status-paid{% elif checkin.payment_status == 'PARTIAL' %}status-partial{% elif checkin.payment_status == 'PENDING' %}status-pending{% else %}status-refunded{% endif %}">
                                {{ checkin.get_payment_status_display }}
                            </span>
                            <br>
                        <form method="post" action="{% url 'checkin-update-payment' checkin.id %}"
                            style="margin-top: 10px;">
                            {% csrf_token %}
                            <select name="payment_status" class="form-control"
                                style="width: auto; display: inline-block; margin-right: 10px;">
                                {% for value, label in checkin.PAYMENT_STATUS_CHOICES %}
                                <option value="{{ value }}" {% if checkin.payment_status==value %}selected{% endif %}>{{
                                    label }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary">Update</button>
                        </form>
                        </p>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">ID
                            Verification:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            {% if checkin.id_proof_verified %}
                            <span class="status-active">‚úÖ Verified</span>
                            {% else %}
                            <span class="status-inactive">‚ùå Pending Verification</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Total
                            Amount:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <span style="font-size: 1.2rem; color: #28a745; font-weight: bold;">‚Çπ{{ checkin.total_amount
                                }}</span>
                        </p>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Advance
                            Payment:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <span style="color: #17a2b8; font-weight: bold;">‚Çπ{{ checkin.advance_payment }}</span>
                        </p>
                    </div>
                    <div>
                        <label
                            style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Remaining:</label>
                        <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <span style="color: #dc3545; font-weight: bold;">‚Çπ{{ checkin.remaining_amount }}</span>
                        </p>
                    </div>
                </div>

                {% if checkin.remarks_notes %}
                <div style="margin-bottom: 25px;">
                    <label
                        style="display: block; font-weight: bold; color: #333; margin-bottom: 5px;">Remarks/Notes:</label>
                    <div
                        style="margin: 0; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff;">
                        {{ checkin.remarks_notes|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div>
            <!-- Quick Stats -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-body">
                    <h4 style="color: #333; margin-bottom: 15px;">üìä Quick Stats</h4>
                    <div style="text-align: center;">
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 32px; font-weight: bold; color: #28a745;">{{
                                checkin.days_since_checkin }}</div>
                            <div style="font-size: 14px; color: #666;">Days Since Check-In</div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">{{
                                checkin.payment_percentage|floatformat:0 }}%</div>
                            <div style="font-size: 14px; color: #666;">Payment Complete</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Summary -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-body">
                    <h4 style="color: #333; margin-bottom: 15px;">‚ú® Status Summary</h4>
                    <div style="font-size: 14px; color: #666;">
                        <div style="margin-bottom: 10px; display: flex; align-items: center;">
                            {% if checkin.payment_status == 'PAID' %}
                            <span style="color: #28a745;">üí∞</span>
                            {% else %}
                            <span style="color: #dc3545;">üí≥</span>
                            {% endif %}
                            <span style="margin-left: 8px;">{{ checkin.get_payment_status_display }}</span>
                        </div>
                        <div style="margin-bottom: 10px; display: flex; align-items: center;">
                            {% if checkin.id_proof_verified %}
                            <span style="color: #28a745;">‚úÖ</span>
                            <span style="margin-left: 8px;">ID Verified</span>
                            {% else %}
                            <span style="color: #dc3545;">‚ùå</span>
                            <span style="margin-left: 8px;">ID Pending</span>
                            {% endif %}
                        </div>
                        <div style="margin-bottom: 10px; display: flex; align-items: center;">
                            {% if checkin.is_walk_in %}
                            <span style="color: #17a2b8;">üö∂</span>
                            <span style="margin-left: 8px;">Walk-in Guest</span>
                            {% else %}
                            <span style="color: #28a745;">üìã</span>
                            <span style="margin-left: 8px;">Pre-booked</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <div class="card-body">
                    <h4 style="color: #333; margin-bottom: 15px;">üïí Timeline</h4>
                    <div style="font-size: 14px; color: #666;">
                        <div style="margin-bottom: 10px;">
                            <strong>Check-In:</strong><br>
                            {{ checkin.actual_check_in_date_time|indian_datetime_12h }}
                        </div>
                        {% if checkin.expected_check_out_date %}
                        <div style="margin-bottom: 10px;">
                            <strong>Expected Check-Out:</strong><br>
                            {{ checkin.expected_check_out_date|indian_date }}
                        </div>
                        {% endif %}
                        <div style="margin-bottom: 10px;">
                            <strong>Created:</strong><br>
                            {{ checkin.created_at|indian_datetime_12h }}
                        </div>
                        <div>
                            <strong>Last Updated:</strong><br>
                            {{ checkin.updated_at|indian_datetime_12h }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}