{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Booking{% else %}New Booking{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/booking_master.css' %}?v=2.0" />
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <h1>{% if form.instance.pk %}Edit Booking{% else %}New Booking{% endif %}</h1>
        <a href="{% url 'booking_list' %}" class="btn btn-secondary">
            ‚Üê Back to Bookings
        </a>
    </div>

    <div class="content-body">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="section">
                <h3 class="section-title">üë§ Customer Information</h3>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.customer_first_name.label_tag }}
                            {{ form.customer_first_name }}
                            {% if form.customer_first_name.errors %}
                            <div class="form-error">{{ form.customer_first_name.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.customer_last_name.label_tag }}
                            {{ form.customer_last_name }}
                            {% if form.customer_last_name.errors %}
                            <div class="form-error">{{ form.customer_last_name.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.phone_number.label_tag }}
                            {{ form.phone_number }}
                            {% if form.phone_number.errors %}
                            <div class="form-error">{{ form.phone_number.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.email.label_tag }}
                            {{ form.email }}
                            {% if form.email.errors %}
                            <div class="form-error">{{ form.email.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üÜî Identity Information</h3>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.id_proof_type.label_tag }}
                            {{ form.id_proof_type }}
                            {% if form.id_proof_type.errors %}
                            <div class="form-error">{{ form.id_proof_type.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.id_number.label_tag }}
                            {{ form.id_number }}
                            {% if form.id_number.errors %}
                            <div class="form-error">{{ form.id_number.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            {{ form.id_photo.label_tag }}
                            {{ form.id_photo }}
                            {% if form.id_photo.errors %}
                            <div class="form-error">{{ form.id_photo.errors }}</div>
                            {% endif %}
                            <small class="form-text">Upload a clear photo of the ID proof</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üè® Booking Details</h3>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.room_type.label_tag }}
                            {{ form.room_type }}
                            {% if form.room_type.errors %}
                            <div class="form-error">{{ form.room_type.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.time_slot.label_tag }}
                            {{ form.time_slot }}
                            {% if form.time_slot.errors %}
                            <div class="form-error">{{ form.time_slot.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.booking_date.label_tag }}
                            {{ form.booking_date }}
                            {% if form.booking_date.errors %}
                            <div class="form-error">{{ form.booking_date.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.booking_time.label_tag }}
                            {{ form.booking_time }}
                            {% if form.booking_time.errors %}
                            <div class="form-error">{{ form.booking_time.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.reservation_source.label_tag }}
                            {{ form.reservation_source }}
                            {% if form.reservation_source.errors %}
                            <div class="form-error">{{ form.reservation_source.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.payment_method.label_tag }}
                            {{ form.payment_method }}
                            {% if form.payment_method.errors %}
                            <div class="form-error">{{ form.payment_method.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            {{ form.applied_discount.label_tag }}
                            {{ form.applied_discount }}
                            {% if form.applied_discount.errors %}
                            <div class="form-error">{{ form.applied_discount.errors }}</div>
                            {% endif %}
                            <small class="form-text">Select a discount from the reservation source</small>
                        </div>
                        <div class="form-group">
                            <!-- Empty for spacing -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üí∞ Pricing Breakdown</h3>
                <div class="section-content">
                    <!-- Hidden form fields for data submission -->
                    <div style="display: none;">
                        {{ form.base_amount }}
                        {{ form.discount_amount }}
                        {{ form.total_amount }}
                    </div>

                    <!-- Pricing Display -->
                    <div class="pricing-breakdown">
                        <div class="pricing-item">
                            <div class="pricing-label">
                                <span class="pricing-icon">üíµ</span>
                                <span>Base Amount</span>
                            </div>
                            <div class="pricing-value" id="baseAmountDisplay"
                                style="font-weight: 800 !important; font-size: 28px !important; color: #343a40 !important; font-family: 'Segoe UI', sans-serif !important;">
                                ‚Çπ0.00</div>
                        </div>

                        <div class="pricing-item discount-item" id="discountRow" style="display: none;">
                            <div class="pricing-label">
                                <span class="pricing-icon">üé´</span>
                                <span>Discount Applied</span>
                            </div>
                            <div class="pricing-value discount-value" id="discountAmountDisplay"
                                style="font-weight: 800 !important; font-size: 30px !important; color: #dc3545 !important; font-family: 'Segoe UI', sans-serif !important;">
                                -‚Çπ0.00</div>
                        </div>

                        <div class="pricing-divider"></div>

                        <div class="pricing-item total-item">
                            <div class="pricing-label total-label">
                                <span class="pricing-icon">üí∞</span>
                                <span>Total Amount</span>
                            </div>
                            <div class="pricing-value total-value" id="totalAmountDisplay"
                                style="font-weight: 900 !important; font-size: 36px !important; color: white !important; font-family: 'Segoe UI', sans-serif !important; text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;">
                                ‚Çπ0.00</div>
                        </div>

                        <div class="pricing-note">
                            <small>üí° Prices are calculated based on room type, time slot, and applied discounts</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üíº Additional Information</h3>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group full-width">
                            {{ form.gst_number.label_tag }}
                            {{ form.gst_number }}
                            {% if form.gst_number.errors %}
                            <div class="form-error">{{ form.gst_number.errors }}</div>
                            {% endif %}
                            <small class="form-text">Optional - for business bookings</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <a href="{% url 'booking_list' %}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    üíæ {% if form.instance.pk %}Update Booking{% else %}Create Booking{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // AJAX functionality for dynamic form updates
    function updateTimeSlotsAndPrice() {
        const roomTypeSelect = document.getElementById('id_room_type');
        const timeSlotSelect = document.getElementById('id_time_slot');

        if (roomTypeSelect.value) {
            // Store current selection before rebuilding
            const currentTimeSlotValue = timeSlotSelect.value;

            // Add loading state
            timeSlotSelect.innerHTML = '<option value="">Loading...</option>';
            timeSlotSelect.disabled = true;

            fetch(`/booking_master/ajax/get_time_slots/?room_type_id=${roomTypeSelect.value}`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Time slots data:', data);
                    timeSlotSelect.innerHTML = '<option value="">Select Time Slot</option>';
                    if (data.time_slots && data.time_slots.length > 0) {
                        data.time_slots.forEach(slot => {
                            const selected = slot.id == currentTimeSlotValue ? 'selected' : '';
                            timeSlotSelect.innerHTML += `<option value="${slot.id}" ${selected}>${slot.name} (${slot.time} hrs)</option>`;
                        });
                    } else {
                        timeSlotSelect.innerHTML += '<option value="">No time slots available</option>';
                    }
                    timeSlotSelect.disabled = false;

                    // Restore the selected value
                    if (currentTimeSlotValue) {
                        timeSlotSelect.value = currentTimeSlotValue;
                    }

                    // Calculate total if time slot is selected
                    if (timeSlotSelect.value) {
                        calculateTotal();
                    }
                })
                .catch(error => {
                    console.error('Error loading time slots:', error);
                    timeSlotSelect.innerHTML = '<option value="">Error loading slots</option>';
                    timeSlotSelect.disabled = false;
                });
        } else {
            timeSlotSelect.innerHTML = '<option value="">Select Room Type first</option>';
            timeSlotSelect.disabled = true;
        }
    }

    // Function to calculate and update total amount
    function calculateTotal() {
        const roomTypeSelect = document.getElementById('id_room_type');
        const timeSlotSelect = document.getElementById('id_time_slot');
        const discountSelect = document.getElementById('id_applied_discount');

        // Hidden form fields for data submission
        const baseAmountField = document.getElementById('id_base_amount');
        const discountAmountField = document.getElementById('id_discount_amount');
        const totalAmountField = document.getElementById('id_total_amount');

        // Display elements
        const baseAmountDisplay = document.getElementById('baseAmountDisplay');
        const discountAmountDisplay = document.getElementById('discountAmountDisplay');
        const totalAmountDisplay = document.getElementById('totalAmountDisplay');
        const discountRow = document.getElementById('discountRow');

        if (roomTypeSelect.value && timeSlotSelect.value) {
            // Get price from server
            fetch(`/booking_master/ajax/get_price/?room_type_id=${roomTypeSelect.value}&time_slot_id=${timeSlotSelect.value}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Price data:', data);
                    const baseAmount = parseFloat(data.price || 0);

                    // Update hidden form fields
                    baseAmountField.value = baseAmount.toFixed(2);

                    // Calculate discount
                    let discountAmount = 0;
                    if (discountSelect.value && discountSelect.selectedOptions[0]) {
                        const discountText = discountSelect.selectedOptions[0].text;
                        const discountMatch = discountText.match(/\(([^)]+)\)/);
                        if (discountMatch) {
                            const discountValue = discountMatch[1];
                            if (discountValue.endsWith('%')) {
                                const percent = parseFloat(discountValue.replace('%', ''));
                                discountAmount = baseAmount * (percent / 100);
                            } else {
                                discountAmount = parseFloat(discountValue) || 0;
                            }
                        }
                    }

                    const totalAmount = Math.max(0, baseAmount - discountAmount);

                    // Update hidden form fields
                    discountAmountField.value = discountAmount.toFixed(2);
                    totalAmountField.value = totalAmount.toFixed(2);

                    // Update display elements
                    baseAmountDisplay.textContent = `‚Çπ${baseAmount.toFixed(2)}`;
                    discountAmountDisplay.textContent = `-‚Çπ${discountAmount.toFixed(2)}`;
                    totalAmountDisplay.textContent = `‚Çπ${totalAmount.toFixed(2)}`;

                    // Show/hide discount row
                    if (discountAmount > 0) {
                        discountRow.style.display = 'flex';
                    } else {
                        discountRow.style.display = 'none';
                    }

                    // Add animation effect
                    [baseAmountDisplay, discountAmountDisplay, totalAmountDisplay].forEach(el => {
                        el.classList.add('updating');
                        setTimeout(() => el.classList.remove('updating'), 300);
                    });

                    console.log(`Base: ‚Çπ${baseAmount}, Discount: ‚Çπ${discountAmount}, Total: ‚Çπ${totalAmount}`);
                })
                .catch(error => {
                    console.error('Error calculating price:', error);
                    // Update hidden form fields
                    baseAmountField.value = '0.00';
                    discountAmountField.value = '0.00';
                    totalAmountField.value = '0.00';

                    // Update display elements
                    baseAmountDisplay.textContent = '‚Çπ0.00';
                    discountAmountDisplay.textContent = '-‚Çπ0.00';
                    totalAmountDisplay.textContent = '‚Çπ0.00';
                    discountRow.style.display = 'none';
                });
        } else {
            // Reset values if room type or time slot not selected
            baseAmountField.value = '0.00';
            discountAmountField.value = '0.00';
            totalAmountField.value = '0.00';

            baseAmountDisplay.textContent = '‚Çπ0.00';
            discountAmountDisplay.textContent = '-‚Çπ0.00';
            totalAmountDisplay.textContent = '‚Çπ0.00';
            discountRow.style.display = 'none';
        }
    }

    // Function to update available discounts based on reservation source
    function updateAvailableDiscounts() {
        const sourceSelect = document.getElementById('id_reservation_source');
        const discountSelect = document.getElementById('id_applied_discount');

        if (sourceSelect.value) {
            // Store current selection before rebuilding
            const currentDiscountValue = discountSelect.value;

            // Add loading state
            discountSelect.innerHTML = '<option value="">Loading...</option>';
            discountSelect.disabled = true;

            fetch(`/booking_master/ajax/get_available_discounts/?reservation_source_id=${sourceSelect.value}`)
                .then(response => {
                    console.log('Discount response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Available discounts data:', data);
                    discountSelect.innerHTML = '<option value="">No discount</option>';
                    if (data.discounts && data.discounts.length > 0) {
                        data.discounts.forEach(discount => {
                            const selected = discount.id == currentDiscountValue ? 'selected' : '';
                            discountSelect.innerHTML += `<option value="${discount.id}" ${selected}>${discount.description} (${discount.discount_value})</option>`;
                        });
                    } else {
                        discountSelect.innerHTML += '<option value="">No discounts available</option>';
                    }
                    discountSelect.disabled = false;

                    // Restore the selected value
                    if (currentDiscountValue) {
                        discountSelect.value = currentDiscountValue;
                    }

                    // Recalculate total after discounts are loaded
                    calculateTotal();
                })
                .catch(error => {
                    console.error('Error loading discounts:', error);
                    discountSelect.innerHTML = '<option value="">Error loading discounts</option>';
                    discountSelect.disabled = false;
                });
        } else {
            discountSelect.innerHTML = '<option value="">Select Reservation Source first</option>';
            discountSelect.disabled = true;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        const roomTypeSelect = document.getElementById('id_room_type');
        const sourceSelect = document.getElementById('id_reservation_source');

        if (roomTypeSelect) {
            roomTypeSelect.addEventListener('change', updateTimeSlotsAndPrice);
            // Trigger on page load if room type is already selected
            if (roomTypeSelect.value) {
                updateTimeSlotsAndPrice();
            }
        }

        if (sourceSelect) {
            sourceSelect.addEventListener('change', updateAvailableDiscounts);
            // Trigger on page load if reservation source is already selected
            if (sourceSelect.value) {
                updateAvailableDiscounts();
            }
        }

        // Add event listeners for price calculation
        const timeSlotSelect = document.getElementById('id_time_slot');
        const discountSelect = document.getElementById('id_applied_discount');

        if (timeSlotSelect) {
            timeSlotSelect.addEventListener('change', calculateTotal);
        }

        if (discountSelect) {
            discountSelect.addEventListener('change', calculateTotal);
        }

        // Calculate total on page load if all required fields are selected
        setTimeout(() => {
            if (roomTypeSelect.value && document.getElementById('id_time_slot').value) {
                calculateTotal();
            }
        }, 500);
    });
</script>
{% endblock %}